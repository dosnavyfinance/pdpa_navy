<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ลงทะเบียน PDPA</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 30px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      color: #333;
    }
    .hidden {
      display: none;
    }
    img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      display: block;
      margin: 0 auto 20px;
      border: 2px solid #ccc;
    }
    h2, h3 {
      text-align: center;
      color: #2c3e50;
    }
    button {
      padding: 10px 20px;
      background-color: #2d87f0;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
    }
    button:hover {
      background-color: #226ccc;
    }
    #pdpaSection {
      margin-top: 30px;
    }
    .pdpa-box {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      background-color: #fdfdfd;
      margin-bottom: 15px;
    }
    .consent-area {
      margin-top: 10px;
    }
    .lds-ring {
    display: inline-block;
    position: relative;
    width: 64px;
    height: 64px;
  }
  .lds-ring div {
    box-sizing: border-box;
    display: block;
    position: absolute;
    width: 51px;
    height: 51px;
    margin: 6px;
    border: 6px solid #2d87f0;
    border-radius: 50%;
    animation: lds-ring 1.2s linear infinite;
    border-color: #2d87f0 transparent transparent transparent;
  }
  @keyframes lds-ring {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  #loadingSpinner {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.2rem;
  background: rgba(255,255,255,0.8);
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  z-index: 9999;
}
  </style>

</head>
<body>
  <div class="container">
    <h2>แสดงข้อมูลผู้ใช้ LINE</h2>
    <img id="profileImage">
    <label>User ID</label>
    <input type="text" id="userId" readonly>

    <label>Display Name</label>
    <input type="text" id="displayName" readonly>

    <label>Status Message</label>
    <input type="text" id="statusMessage" readonly>

    <hr>
    <div id="idCardSection" class="hidden">
      <h3>กรุณากรอกเลขบัตรประชาชน</h3>
      <input type="text" id="idCardInput" placeholder="กรอกเลขบัตร 13 หลัก">
      <button onclick="showPDPASection()">ถัดไป</button>
    </div>
    
    <div id="loadingSpinner" class="hidden" style="text-align:center;">
    <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
    <p>กำลังโหลดข้อมูล...</p>
    </div>  
    
    <div id="pdpaSection" class="hidden">
    <h3>ข้อมูลของคุณ</h3>
    <p><strong>ยศ:</strong> <span id="userTitle"></span></p>
    <p><strong>ชื่อ:</strong> <span id="userFirstName"></span></p>
    <p><strong>นามสกุล:</strong> <span id="userLastName"></span></p>

    <hr>
    
      <h3>นโยบายคุ้มครองข้อมูลส่วนบุคคล (PDPA)</h3>
      <div class="pdpa-box">
        <h4>1. การเก็บข้อมูล</h4>
        <p>เราจะเก็บข้อมูลส่วนบุคคลที่จำเป็นสำหรับการให้บริการ...</p>
        <h4>2. การใช้ข้อมูล</h4>
        <p>ข้อมูลที่เก็บจะถูกนำไปใช้เพื่อวัตถุประสงค์ที่ชัดเจน เช่น การติดต่อกลับ...</p>
        <h4>3. การเปิดเผยข้อมูล</h4>
        <p>เราจะไม่เปิดเผยข้อมูลส่วนบุคคลของคุณแก่บุคคลภายนอก...</p>
        <h4>4. สิทธิของเจ้าของข้อมูล</h4>
        <p>คุณสามารถร้องขอเข้าถึง แก้ไข หรือเพิกถอนความยินยอมได้...</p>
        <!-- เพิ่มเนื้อหาได้ตามจริง -->
      </div>

      <div class="consent-area" id="consentSection">
        <input type="checkbox" id="consentCheckbox">
        <label for="consentCheckbox">ข้าพเจ้าได้อ่านและยินยอมตามนโยบายข้างต้น</label>
      </div>

      <button onclick="submitConsent()">บันทึกการยินยอม</button>
    </div>
  </div
 <div id="loadingSpinner">กำลังตรวจสอบข้อมูล...</div>   

  <script src="https://static.line-scdn.net/liff/edge/versions/2.9.0/sdk.js"></script>
  <script>
    function runApp() {
      liff.getProfile().then(profile => {
        document.getElementById("profileImage").src = profile.pictureUrl;
        document.getElementById("userId").value = profile.userId;
        document.getElementById("displayName").value = profile.displayName;
        document.getElementById("statusMessage").value = profile.statusMessage || '-';

        document.getElementById("idCardSection").classList.remove("hidden");
      }).catch(err => console.error('getProfile error:', err));
    }

    liff.init({ liffId: "2007674245-8mRaxkdj" }, () => {
      if (liff.isLoggedIn()) {
        runApp();
      } else {
        liff.login();
      }
    }, err => console.error('LIFF init error:', err));

function showPDPASection() {
  const idCard = document.getElementById("idCardInput").value.trim();
  if (!/^\d{13}$/.test(idCard)) {
    alert("กรุณากรอกเลขบัตรประชาชนให้ถูกต้อง (13 หลัก)");
    return;
  }

  showLoading();
  // const lineUserId = document.getElementById("userId").value;

  fetch("https://script.google.com/macros/s/AKfycbwkebYkHKmOQ70-STvMfC6uuUy9MknB9NxrVeRWgQasUFuYP1CacRod_xjroh2-yLle-A/exec", {
    method: "POST",
    body: new URLSearchParams({
      action: "checkIdCard",
      idCard: idCard
    })
  })
    .then(res => res.json())
    .then(data => {
      hideLoading();
      
      if (data.status === 'success') {
      document.getElementById("userTitle").textContent = data.title || '-';
      document.getElementById("userFirstName").textContent = data.firstName || '-';
      document.getElementById("userLastName").textContent = data.lastName || '-';
      document.getElementById("pdpaContent").innerHTML = data.pdpaContent || 'ไม่มีข้อมูล PDPA';

      if (data.consent === '1') {
        alert("คุณได้ยินยอมแล้ว ไม่ต้องทำรายการซ้ำ");
        document.getElementById("consentSection").style.display = "none";
      } else {
        document.getElementById("consentSection").style.display = "block";
      }

      document.getElementById("pdpaSection").classList.remove("hidden");
    } else if (data.status === 'notFound') {
      alert("ไม่พบข้อมูลบัตรประชาชนนี้");
    } else {
      alert(data.message);
    }
  })
  .catch(err => {
    hideLoading();
    alert("เกิดข้อผิดพลาด: " + err.message);
  });
}

function showLoading() {
  document.getElementById("loadingSpinner").style.display = "block";
}
function hideLoading() {
  document.getElementById("loadingSpinner").style.display = "none";
}

    function submitConsent() {
      if (!document.getElementById("consentCheckbox").checked) {
        alert("กรุณายินยอมก่อนบันทึก");
        return;
      }
      alert("บันทึกความยินยอมเรียบร้อย");
      // ต่อไปจะเป็นการส่งข้อมูลไปยัง Google Sheet (ในขั้นถัดไป)
    }
  </script>
</body>
</html>
